<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Трекер машин</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.hidden { display: none; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
button { margin: 5px; }
</style>
</head>
<body>
<h1>Трекер машин</h1>
<div>
<label>Машина:</label>
<select id="vehicleSelect"></select>
<input type="text" id="newVehicle" placeholder="Новая машина" />
<button onclick="addVehicle()">Добавить</button>
</div>
<div>
<label>Направление:</label>
<input type="text" id="direction" />
</div>
<div>
<label>Маршрут:</label>
<input type="text" id="route" />
</div>
<div>
<label>Комментарий:</label>
<input type="text" id="comment" />
</div>
<button onclick="dispatch()">Отправить в рейс</button>

<h2>Сейчас в рейсе</h2>
<table id="activeTable">
<tr><th>Машина</th><th>Направление</th><th>Маршрут</th><th>Комментарий</th><th>Выезд</th><th>Действие</th></tr>
</table>

<h2>История</h2>
<table id="historyTable">
<tr><th>Машина</th><th>Направление</th><th>Маршрут</th><th>Комментарий</th><th>Выезд</th><th>Возврат</th></tr>
</table>

<button onclick="exportCSV()">Скачать CSV</button>
<button id="resetBtn" class="hidden" onclick="confirmReset()">СБРОС ВСЕГО</button>

<script>
let vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
let logs = JSON.parse(localStorage.getItem('logs') || '[]');

function saveData() {
    localStorage.setItem('vehicles', JSON.stringify(vehicles));
    localStorage.setItem('logs', JSON.stringify(logs));
}
function populateVehicles() {
    const select = document.getElementById('vehicleSelect');
    select.innerHTML = '';
    vehicles.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
    });
}
function addVehicle() {
    const v = document.getElementById('newVehicle').value.trim();
    if(v && !vehicles.includes(v)) {
        vehicles.push(v);
        saveData();
        populateVehicles();
        document.getElementById('newVehicle').value='';
    }
}
function dispatch() {
    const vehicle = document.getElementById('vehicleSelect').value;
    const direction = document.getElementById('direction').value;
    const route = document.getElementById('route').value;
    const comment = document.getElementById('comment').value;
    logs.push({vehicle, direction, route, comment, departAt: new Date().toLocaleString(), returnAt: null});
    saveData();
    renderTables();
}
function returnVehicle(index) {
    logs[index].returnAt = new Date().toLocaleString();
    saveData();
    renderTables();
}
function renderTables() {
    const activeTable = document.getElementById('activeTable');
    activeTable.innerHTML = '<tr><th>Машина</th><th>Направление</th><th>Маршрут</th><th>Комментарий</th><th>Выезд</th><th>Действие</th></tr>';
    const historyTable = document.getElementById('historyTable');
    historyTable.innerHTML = '<tr><th>Машина</th><th>Направление</th><th>Маршрут</th><th>Комментарий</th><th>Выезд</th><th>Возврат</th></tr>';
    logs.forEach((log, i) => {
        if(!log.returnAt) {
            const row = activeTable.insertRow();
            row.insertCell().textContent = log.vehicle;
            row.insertCell().textContent = log.direction;
            row.insertCell().textContent = log.route;
            row.insertCell().textContent = log.comment;
            row.insertCell().textContent = log.departAt;
            const btn = document.createElement('button');
            btn.textContent = 'В гараже';
            btn.onclick = () => returnVehicle(i);
            row.insertCell().appendChild(btn);
        } else {
            const row = historyTable.insertRow();
            row.insertCell().textContent = log.vehicle;
            row.insertCell().textContent = log.direction;
            row.insertCell().textContent = log.route;
            row.insertCell().textContent = log.comment;
            row.insertCell().textContent = log.departAt;
            row.insertCell().textContent = log.returnAt;
        }
    });
}
function exportCSV() {
    let csv = 'Машина,Направление,Маршрут,Комментарий,Выезд,Возврат\n';
    logs.forEach(log => {
        csv += `${log.vehicle},${log.direction},${log.route},${log.comment},${log.departAt},${log.returnAt||''}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'logs.csv';
    a.click();
}
function confirmReset() {
    if(confirm("Вы уверены? Это полностью удалит все данные!")) {
        localStorage.clear();
        vehicles=[]; logs=[];
        populateVehicles(); renderTables();
        document.getElementById('resetBtn').classList.add('hidden');
    }
}
document.addEventListener('keydown', e => {
    if(e.altKey && e.code === 'KeyC') {
        document.getElementById('resetBtn').classList.remove('hidden');
    }
});
populateVehicles();
renderTables();
</script>
</body>
</html>